<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Interviewer</title>

    <!-- jsPDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 0;
        background: #0b1220;
        color: #e8eefc;
      }
      .wrap {
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 20px;
      }
      .card {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 16px;
        padding: 22px;
      }
      h1 { margin: 0 0 8px; font-size: 28px; }
      p { margin: 0 0 14px; color: rgba(232,238,252,0.85); line-height: 1.4; }
      .steps { margin-top: 14px; padding-left: 18px; color: rgba(232,238,252,0.85); }
      .badge {
        display: inline-block;
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(99,102,241,0.18);
        border: 1px solid rgba(99,102,241,0.35);
        margin-bottom: 12px;
      }
      .footer { margin-top: 18px; font-size: 12px; color: rgba(232,238,252,0.6); }

      /* Botón flotante */
      #downloadReportBtn {
        position: fixed;
        right: 18px;
        bottom: 96px; /* arriba del chat */
        z-index: 999999;
        display: none;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.15);
        background: rgba(99,102,241,0.9);
        color: white;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      }
      #downloadReportBtn:hover { filter: brightness(1.05); }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="badge">Gratis · Sin registro</div>

      <div class="card">
        <h1>Simulador de entrevista</h1>
        <p>Practica entrevistas con un entrevistador IA. Responde con naturalidad, como si fuera una entrevista real.</p>

        <p><strong>Cómo usarlo:</strong></p>
        <ol class="steps">
          <li>Abre el chat (abajo a la derecha).</li>
          <li>Escribe lo que te pide el bot (Nombre, Empresa, Puesto, Seniority).</li>
          <li>Contesta las preguntas.</li>
          <li>Al final podrás descargar tu informe en PDF.</li>
        </ol>

        <div class="footer">
          Tip: responde con ejemplos concretos (situación → acción → resultado).
        </div>
      </div>
    </div>

    <button id="downloadReportBtn">Descargar informe (PDF)</button>

    <script type="text/javascript">
      (function (d, t) {
        var v = d.createElement(t), s = d.getElementsByTagName(t)[0];

        // Guardamos el último PDF generado para descargar con click
        let latestPdf = { blobUrl: null, filename: null };

        function showDownloadButton(blobUrl, filename) {
          latestPdf.blobUrl = blobUrl;
          latestPdf.filename = filename;

          const btn = document.getElementById("downloadReportBtn");
          btn.style.display = "block";

          btn.onclick = () => {
            const a = document.createElement("a");
            a.href = latestPdf.blobUrl;
            a.download = latestPdf.filename || "Interview_Report.pdf";
            document.body.appendChild(a);
            a.click();
            a.remove();
          };
        }

        v.onload = function () {
          const DownloadReportExtension = {
            name: "download_report_pdf",
            type: "effect",

            match: ({ trace }) =>
              trace?.type === "custom_action" &&
              trace?.payload?.name === "DOWNLOAD_REPORT_PDF",

            effect: ({ trace }) => {
              const payload = trace.payload.payload || {};

              const reportText = payload.report_text || "";
              const candidate = payload.candidate_name || "Candidate";
              const company = payload.company || "Company";
              const role = payload.role || "Role";

              const { jsPDF } = window.jspdf;
              const doc = new jsPDF({ unit: "pt", format: "a4" });

              const marginX = 40;
              let y = 50;

              doc.setFont("helvetica", "bold");
              doc.setFontSize(16);
              doc.text("HR Evaluation Report", marginX, y);

              y += 20;
              doc.setFont("helvetica", "normal");
              doc.setFontSize(11);
              doc.text(`${candidate} — ${role} @ ${company}`, marginX, y);

              y += 30;
              doc.setFontSize(10);
              const lines = doc.splitTextToSize(reportText, 515);
              doc.text(lines, marginX, y);

              const safe = (s) => String(s).replace(/[^\w]+/g, "_");
              const filename = `Interview_Report_${safe(candidate)}_${safe(company)}.pdf`;

              // Generar PDF como Blob (no descarga automática)
              const pdfBlob = doc.output("blob");
              const blobUrl = URL.createObjectURL(pdfBlob);

              showDownloadButton(blobUrl, filename);
            }
          };

          window.voiceflow.chat.load({
            verify: { projectID: "6981de99392d1c3e0b9084bf" },
            url: "https://general-runtime.voiceflow.com",
            versionID: "production",
            voice: { url: "https://runtime-api.voiceflow.com" },

            // OJO: en algunos builds de VF es "extensions" a nivel raíz.
            // Si no te funciona, cambia a: extensions: [DownloadReportExtension]
            assistant: { extensions: [DownloadReportExtension] }
          });
        };

        v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs";
        v.type = "text/javascript";
        s.parentNode.insertBefore(v, s);
      })(document, "script");
    </script>
  </body>
</html>
